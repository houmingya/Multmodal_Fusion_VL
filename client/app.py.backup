# ====================================
# æœ¬åœ°ç«¯ä»£ç  - Gradioå¯è§†åŒ–ç•Œé¢
# ====================================
# åŠŸèƒ½ï¼šå›¾æ–‡é—®ç­” + æ–‡æœå›¾ äº¤äº’ç•Œé¢
# ç¯å¢ƒï¼šæœ¬åœ°PC + Python 3.10+
# ä¾èµ–ï¼šgradio, requests, Pillow

import gradio as gr
import requests
import base64
from io import BytesIO
from PIL import Image
import json

# ====================================
# é…ç½®é¡¹ï¼ˆæ ¹æ®æœåŠ¡å™¨å®é™…åœ°å€ä¿®æ”¹ï¼‰
# ====================================
SERVER_URL = "http://localhost:8000"  # æœåŠ¡å™¨åœ°å€ï¼ˆä¿®æ”¹ä¸ºå®é™…IP:ç«¯å£ï¼‰

# ====================================
# å·¥å…·å‡½æ•°
# ====================================
def check_server_health():
    """
    æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€
    è¿”å›ï¼šè¿æ¥çŠ¶æ€æ¶ˆæ¯
    """
    try:
        response = requests.get(f"{SERVER_URL}/health", timeout=5)
        if response.status_code == 200:
            data = response.json()
            return f"âœ“ æœåŠ¡å™¨è¿æ¥æ­£å¸¸\nè®¾å¤‡: {data['device']}\nå›¾ç‰‡åº“: {data['image_library_size']}å¼ "
        else:
            return f"âœ— æœåŠ¡å™¨å“åº”å¼‚å¸¸ (çŠ¶æ€ç : {response.status_code})"
    except requests.exceptions.ConnectionError:
        return "âœ— æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨\n2. SERVER_URLé…ç½®æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œ/é˜²ç«å¢™è®¾ç½®"
    except Exception as e:
        return f"âœ— è¿æ¥å¤±è´¥: {str(e)}"

# ====================================
# åŠŸèƒ½1ï¼šå›¾æ–‡é—®ç­”ï¼ˆVQAï¼‰
# ====================================
def vqa_inference(image, question):
    """
    å›¾æ–‡é—®ç­”åŠŸèƒ½
    è¾“å…¥ï¼šPILå›¾ç‰‡å¯¹è±¡ + ä¸­æ–‡é—®é¢˜
    è¾“å‡ºï¼šæ¨¡å‹å›ç­”æ–‡æœ¬
    """
    # 1. è¾“å…¥éªŒè¯
    if image is None:
        return "âš  è¯·å…ˆä¸Šä¼ å›¾ç‰‡ï¼"
    
    if not question or question.strip() == "":
        return "âš  è¯·è¾“å…¥é—®é¢˜ï¼"
    
    try:
        # 2. å°†PILå›¾ç‰‡è½¬ä¸ºå­—èŠ‚æµ
        img_byte_arr = BytesIO()
        image.save(img_byte_arr, format='JPEG')
        img_byte_arr.seek(0)
        
        # 3. æ„é€ HTTPè¯·æ±‚
        files = {
            'image': ('image.jpg', img_byte_arr, 'image/jpeg')
        }
        data = {
            'question': question.strip()
        }
        
        # 4. å‘é€POSTè¯·æ±‚åˆ°æœåŠ¡å™¨
        response = requests.post(
            f"{SERVER_URL}/vqa",
            files=files,
            data=data,
            timeout=60  # VQAæ¨ç†è¾ƒæ…¢ï¼Œè®¾ç½®60ç§’è¶…æ—¶
        )
        
        # 5. è§£æè¿”å›ç»“æœ
        if response.status_code == 200:
            result = response.json()
            answer = result.get('answer', 'æœªè¿”å›ç­”æ¡ˆ')
            return f"ğŸ¤– æ¨¡å‹å›ç­”ï¼š\n\n{answer}"
        else:
            error_detail = response.json().get('detail', 'æœªçŸ¥é”™è¯¯')
            return f"âœ— æ¨ç†å¤±è´¥: {error_detail}"
            
    except requests.exceptions.Timeout:
        return "âœ— è¯·æ±‚è¶…æ—¶ï¼ŒæœåŠ¡å™¨å¯èƒ½è´Ÿè½½è¿‡é«˜æˆ–æ¨¡å‹æ¨ç†è¾ƒæ…¢ï¼Œè¯·ç¨åé‡è¯•"
    except requests.exceptions.ConnectionError:
        return "âœ— æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ"
    except Exception as e:
        return f"âœ— å‘ç”Ÿé”™è¯¯: {str(e)}"

# ====================================
# åŠŸèƒ½2ï¼šæ–‡æœå›¾ï¼ˆText-to-Image Searchï¼‰
# ====================================
def text2image_search(text_query, top_k):
    """
    æ–‡æœå›¾åŠŸèƒ½
    è¾“å…¥ï¼šä¸­æ–‡æ–‡æœ¬æè¿° + è¿”å›æ•°é‡
    è¾“å‡ºï¼šæœ€ç›¸ä¼¼çš„å›¾ç‰‡åˆ—è¡¨
    """
    # 1. è¾“å…¥éªŒè¯
    if not text_query or text_query.strip() == "":
        return [], "âš  è¯·è¾“å…¥æ£€ç´¢æ–‡æœ¬ï¼"
    
    try:
        # 2. æ„é€ HTTPè¯·æ±‚
        data = {
            'text_query': text_query.strip(),
            'top_k': int(top_k)
        }
        
        # 3. å‘é€POSTè¯·æ±‚
        response = requests.post(
            f"{SERVER_URL}/text2image_search",
            data=data,
            timeout=30
        )
        
        # 4. è§£æè¿”å›ç»“æœ
        if response.status_code == 200:
            result = response.json()
            results = result.get('results', [])
            
            if not results:
                return [], "æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ç‰‡"
            
            # 5. è§£ç Base64å›¾ç‰‡
            images = []
            info_text = f"ğŸ” æ£€ç´¢ç»“æœï¼ˆå…±{len(results)}å¼ ï¼‰ï¼š\n\n"
            
            for i, item in enumerate(results, 1):
                # è§£ç Base64å›¾ç‰‡
                # æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
                if 'image_base64' not in item:
                    return [], f"âœ— æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ï¼Œç¼ºå°‘image_base64å­—æ®µã€‚å®é™…å­—æ®µ: {list(item.keys())}"
                img_data = base64.b64decode(item['image_base64'])
                img = Image.open(BytesIO(img_data))
                images.append(img)
                
                # æ„é€ ä¿¡æ¯æ–‡æœ¬
                info_text += f"{i}. {item['image']}\n"
                info_text += f"   ç›¸ä¼¼åº¦: {item['score']:.4f}\n\n"
            
            return images, info_text
        else:
            error_detail = response.json().get('detail', 'æœªçŸ¥é”™è¯¯')
            return [], f"âœ— æ£€ç´¢å¤±è´¥: {error_detail}"
            
    except requests.exceptions.Timeout:
        return [], "âœ— è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•"
    except requests.exceptions.ConnectionError:
        return [], "âœ— æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ"
    except Exception as e:
        return [], f"âœ— å‘ç”Ÿé”™è¯¯: {str(e)}"

# ====================================
# Gradioç•Œé¢æ„å»º
# ====================================
def build_interface():
    """
    æ„å»ºGradioå¯è§†åŒ–ç•Œé¢
    åŒ…å«ä¸¤ä¸ªæ ‡ç­¾é¡µï¼šå›¾æ–‡é—®ç­” + æ–‡æœå›¾
    """
    
    # è‡ªå®šä¹‰CSSæ ·å¼ï¼ˆæ”¯æŒä¸­æ–‡æ˜¾ç¤ºï¼‰
    custom_css = """
    .gradio-container {
        font-family: "Microsoft YaHei", "SimHei", sans-serif !important;
    }
    """
    
    with gr.Blocks(
        title="å¤šæ¨¡æ€èåˆDemo - å›¾æ–‡é—®ç­”+æ–‡æœå›¾",
        css=custom_css,
        theme=gr.themes.Soft()
    ) as demo:
        
        # æ ‡é¢˜å’Œè¯´æ˜
        gr.Markdown(
            """
            # ğŸš€ å¤šæ¨¡æ€èåˆDemo - åŸºäºé­”æ­ç¤¾åŒº
            
            **åŠŸèƒ½**ï¼šå›¾æ–‡é—®ç­”ï¼ˆVQAï¼‰ + æ–‡æœå›¾ï¼ˆText-to-Image Searchï¼‰
            
            **æ¨¡å‹**ï¼šLLaVA-1.5-7B + CLIPä¸­æ–‡è½»é‡ç‰ˆ
            
            ---
            """
        )
        
        # æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
        with gr.Row():
            server_status = gr.Textbox(
                label="ğŸ“¡ æœåŠ¡å™¨è¿æ¥çŠ¶æ€",
                value="ç‚¹å‡»å³ä¾§æŒ‰é’®æ£€æŸ¥è¿æ¥...",
                interactive=False,
                lines=3
            )
            check_btn = gr.Button("ğŸ”„ æ£€æŸ¥è¿æ¥", size="sm")
        
        check_btn.click(
            fn=check_server_health,
            inputs=[],
            outputs=server_status
        )
        
        # ====================================
        # æ ‡ç­¾é¡µ1ï¼šå›¾æ–‡é—®ç­”
        # ====================================
        with gr.Tab("ğŸ“· å›¾æ–‡é—®ç­”ï¼ˆVQAï¼‰"):
            gr.Markdown("### ä¸Šä¼ å›¾ç‰‡å¹¶æé—®ï¼Œæ¨¡å‹å°†åŸºäºå›¾ç‰‡å†…å®¹å›ç­”æ‚¨çš„é—®é¢˜")
            
            with gr.Row():
                with gr.Column(scale=1):
                    vqa_image = gr.Image(
                        label="ä¸Šä¼ å›¾ç‰‡",
                        type="pil",
                        height=300
                    )
                    vqa_question = gr.Textbox(
                        label="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼ˆä¸­æ–‡ï¼‰",
                        placeholder="ä¾‹å¦‚ï¼šå›¾ç‰‡ä¸­æœ‰ä»€ä¹ˆï¼Ÿè¿™æ˜¯ä»€ä¹ˆåœºæ™¯ï¼Ÿ",
                        lines=3
                    )
                    vqa_submit_btn = gr.Button("ğŸš€ æäº¤é—®ç­”", variant="primary")
                
                with gr.Column(scale=1):
                    vqa_answer = gr.Textbox(
                        label="æ¨¡å‹å›ç­”",
                        lines=10,
                        interactive=False
                    )
            
            # ç¤ºä¾‹é—®é¢˜
            gr.Examples(
                examples=[
                    ["å›¾ç‰‡ä¸­æœ‰ä»€ä¹ˆï¼Ÿ"],
                    ["æè¿°ä¸€ä¸‹è¿™å¼ å›¾ç‰‡"],
                    ["å›¾ç‰‡ä¸­çš„ä¸»è¦ç‰©ä½“æ˜¯ä»€ä¹ˆï¼Ÿ"],
                    ["è¿™æ˜¯ä»€ä¹ˆåœºæ™¯ï¼Ÿ"]
                ],
                inputs=vqa_question,
                label="ğŸ’¡ ç¤ºä¾‹é—®é¢˜"
            )
            
            # ç»‘å®šäº‹ä»¶
            vqa_submit_btn.click(
                fn=vqa_inference,
                inputs=[vqa_image, vqa_question],
                outputs=vqa_answer
            )
        
        # ====================================
        # æ ‡ç­¾é¡µ2ï¼šæ–‡æœå›¾
        # ====================================
        with gr.Tab("ğŸ” æ–‡æœå›¾ï¼ˆText-to-Image Searchï¼‰"):
            gr.Markdown("### è¾“å…¥æ–‡å­—æè¿°ï¼Œä»æœåŠ¡å™¨å›¾ç‰‡åº“ä¸­æ£€ç´¢æœ€åŒ¹é…çš„å›¾ç‰‡")
            
            with gr.Row():
                with gr.Column(scale=1):
                    search_text = gr.Textbox(
                        label="è¾“å…¥æ£€ç´¢æ–‡æœ¬ï¼ˆä¸­æ–‡ï¼‰",
                        placeholder="ä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„çŒ«ã€ç¾ä¸½çš„æ—¥è½ã€ç‹—åœ¨è‰åœ°ä¸Š",
                        lines=3
                    )
                    search_top_k = gr.Slider(
                        label="è¿”å›å›¾ç‰‡æ•°é‡",
                        minimum=1,
                        maximum=10,
                        value=3,
                        step=1
                    )
                    search_btn = gr.Button("ğŸ” å¼€å§‹æ£€ç´¢", variant="primary")
                    
                    search_info = gr.Textbox(
                        label="æ£€ç´¢ç»“æœä¿¡æ¯",
                        lines=8,
                        interactive=False
                    )
            
            with gr.Row():
                search_gallery = gr.Gallery(
                    label="åŒ¹é…çš„å›¾ç‰‡ï¼ˆæŒ‰ç›¸ä¼¼åº¦æ’åºï¼‰",
                    columns=3,
                    height=400
                )
            
            # ç¤ºä¾‹æ–‡æœ¬
            gr.Examples(
                examples=[
                    ["ä¸€åªå¯çˆ±çš„çŒ«"],
                    ["ç¾ä¸½çš„æ—¥è½é£æ™¯"],
                    ["ç‹—åœ¨è‰åœ°ä¸Šå¥”è·‘"],
                    ["åŸå¸‚å¤œæ™¯"]
                ],
                inputs=search_text,
                label="ğŸ’¡ ç¤ºä¾‹æ£€ç´¢æ–‡æœ¬"
            )
            
            # ç»‘å®šäº‹ä»¶
            search_btn.click(
                fn=text2image_search,
                inputs=[search_text, search_top_k],
                outputs=[search_gallery, search_info]
            )
        
        # é¡µè„šè¯´æ˜
        gr.Markdown(
            """
            ---
            
            ### ğŸ“Œ ä½¿ç”¨è¯´æ˜
            
            **å›¾æ–‡é—®ç­”**ï¼š
            1. ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼ˆæ”¯æŒjpg/png/webpç­‰æ ¼å¼ï¼‰
            2. è¾“å…¥æ‚¨æƒ³é—®çš„é—®é¢˜ï¼ˆä¸­æ–‡ï¼‰
            3. ç‚¹å‡»"æäº¤é—®ç­”"æŒ‰é’®
            4. ç­‰å¾…æœåŠ¡å™¨æ¨ç†ï¼ˆçº¦5-15ç§’ï¼‰
            
            **æ–‡æœå›¾**ï¼š
            1. è¾“å…¥æƒ³æ£€ç´¢çš„æ–‡å­—æè¿°ï¼ˆä¸­æ–‡ï¼‰
            2. é€‰æ‹©è¿”å›å›¾ç‰‡æ•°é‡
            3. ç‚¹å‡»"å¼€å§‹æ£€ç´¢"æŒ‰é’®
            4. æŸ¥çœ‹åŒ¹é…ç»“æœå’Œç›¸ä¼¼åº¦åˆ†æ•°
            
            ### âš™ï¸ é…ç½®æœåŠ¡å™¨åœ°å€
            
            è¯·åœ¨ä»£ç ç¬¬15è¡Œä¿®æ”¹ `SERVER_URL` å˜é‡ï¼š
            ```python
            SERVER_URL = "http://æ‚¨çš„æœåŠ¡å™¨IP:8000"
            ```
            
            ### â“ å¸¸è§é—®é¢˜
            
            - **è¿æ¥å¤±è´¥**ï¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨ï¼Œé˜²ç«å¢™æ˜¯å¦å¼€æ”¾8000ç«¯å£
            - **æ¨ç†è¶…æ—¶**ï¼šé¦–æ¬¡æ¨ç†éœ€è¦åŠ è½½æ¨¡å‹ï¼Œè€å¿ƒç­‰å¾…60ç§’
            - **å›¾ç‰‡åº“ä¸ºç©º**ï¼šåœ¨æœåŠ¡å™¨ç«¯ `image_library/` ç›®å½•æ·»åŠ å›¾ç‰‡
            """
        )
    
    return demo

# ====================================
# å¯åŠ¨Gradioç•Œé¢
# ====================================
if __name__ == "__main__":
    print("\n" + "=" * 60)
    print("  å¤šæ¨¡æ€èåˆå®¢æˆ·ç«¯å¯åŠ¨ä¸­...")
    print("=" * 60)
    print(f"  æœåŠ¡å™¨åœ°å€: {SERVER_URL}")
    print("  å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç¼–è¾‘ä»£ç ç¬¬15è¡Œçš„ SERVER_URL å˜é‡")
    print("=" * 60 + "\n")
    
    demo = build_interface()
    
    # å¯åŠ¨Gradioï¼ˆè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼‰
    demo.launch(
        server_name="127.0.0.1",  # æœ¬åœ°è®¿é—®
        server_port=7860,          # Gradioé»˜è®¤ç«¯å£
        share=False,               # ä¸ç”Ÿæˆå…¬ç½‘é“¾æ¥
        inbrowser=True             # è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
    )
